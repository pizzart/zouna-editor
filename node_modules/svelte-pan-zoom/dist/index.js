import{resize as J}from"svelte-resize-observer-action";var Y=(e,m)=>Math.hypot(e.x-m.x,e.y-m.y),B=(e,m)=>({x:(e.x+m.x)/2,y:(e.y+m.y)/2}),H=(e,m)=>({x:e.x-m.x,y:e.y-m.y}),N=.02,Q=120;function tt(e,m){let p=window.devicePixelRatio,i=e.getContext("2d"),k=requestAnimationFrame,a,y,g,C,P,L,T,b=e.width=e.clientWidth*p,w=e.height=e.clientHeight*p,u,l=0,r={vx:0,vy:0,ts:0},f=new Map,h=[];function O(t){({width:y,height:g,render:C,padding:P,maxZoom:L,friction:T}={padding:0,maxZoom:16,friction:.97,...t}),a=Math.min(e.width/(y+P*p),e.height/(g+P*p)),i.resetTransform(),i.translate(e.width/2,e.height/2),i.scale(a,a),i.translate(-y/2,-g/2),_(),u=d({x:e.width/2,y:e.height/2}),E()}O(m);let q=J(e,t=>{let n=t.contentRect,o=d({x:b/2,y:w/2}),s=i.getTransform();b=n.width*p,w=n.height*p,e.width=b,e.height=w,a=Math.min(e.width/(m.width+P*p),e.height/(m.height+P*p)),i.setTransform(s),u=d({x:b/2,y:w/2}),i.translate(u.x-o.x,u.y-o.y),l||z(performance.now())});function A(t){for(;h.length&&t-h[0].t>Q;)h.shift()}function K(t){let n=performance.now();A(n),h.push({point:t,t:n})}function _(){l&&(cancelAnimationFrame(l),l=0),r.vx=0,r.vy=0,h.length=0}function S(){let t=d({x:0,y:0}),n=d({x:e.width,y:e.height});t.x>y&&(i.translate(t.x-y,0),r.vx=-r.vx),t.y>g&&(i.translate(0,t.y-g),r.vy=-r.vy),n.x<0&&(i.translate(n.x,0),r.vx=-r.vx),n.y<0&&(i.translate(0,n.y),r.vy=-r.vy)}function F(t){t.stopPropagation(),e.setPointerCapture(t.pointerId);let n=R(t);f.set(t.pointerId,n),_()}function v(t){if(t.stopPropagation(),e.releasePointerCapture(t.pointerId),f.delete(t.pointerId),f.size===0&&(A(performance.now()),h.length>1)){let n=h[0],o=h[h.length-1],s=o.point.x-n.point.x,c=o.point.y-n.point.y,x=o.t-n.t;r={vx:s/x,vy:c/x,ts:performance.now()},E()}}function D(t){if(t.stopPropagation(),!f.has(t.pointerId))return;let n=R(t);switch(f.size){case 1:{let o=d(n);K(o);let s=f.get(t.pointerId),c=H(o,d(s));u=o,M(c),E(),f.set(t.pointerId,n);break}case 2:{let o=[...f.values()],s=d(o[0]),c=d(o[1]),x=B(s,c),U=Y(s,c);f.set(t.pointerId,n),o=[...f.values()],s=d(o[0]),c=d(o[1]);let W=B(s,c),X=Y(s,c),j=H(W,x);M(j);let G=X/U;V(W,G);break}}}function Z(t){t.preventDefault(),t.stopPropagation();let n=R(t),o=Math.exp(-t.deltaY/512);V(d(n),o)}function M(t){i.translate(t.x,t.y),S()}function V(t,n){function o(c){i.translate(t.x,t.y),i.scale(c,c),i.translate(-t.x,-t.y)}o(n);let s=i.getTransform();s.a<a&&o(a/s.a),s.a>L&&o(L/s.a),u=t,E()}function R(t){return{x:t.offsetX*p,y:t.offsetY*p}}function d(t){return i.getTransform().inverse().transformPoint(t)}function E(){l||(l=k(z))}function z(t){i.save(),i.resetTransform(),i.clearRect(0,0,e.width,e.height),i.restore();let n=C(i,t,u),o=Math.abs(r.vx)>N||Math.abs(r.vy)>N;if(o){let s=t-r.ts,c=r.vx*s,x=r.vy*s;M({x:c,y:x}),r.vx*=T,r.vy*=T,r.ts=t}o||n?l=k(z):l=0}let I={passive:!0};return e.addEventListener("pointerdown",F,I),e.addEventListener("pointerup",v,I),e.addEventListener("pointercancel",v,I),e.addEventListener("pointermove",D,I),e.addEventListener("wheel",Z),{update(t){O(t)},destroy(){q.destroy(),e.removeEventListener("pointerdown",F),e.removeEventListener("pointerup",v),e.removeEventListener("pointercancel",v),e.removeEventListener("pointermove",D),e.removeEventListener("wheel",Z)}}}export{tt as panzoom};
